<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hivio LTD ‚Äî Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --text:#e7ecf3; --muted:#a9b0bd; --border:rgba(255,255,255,.10);
      --bg:#070b13;
    }
    html,body{margin:0;height:100%;background:#070b13;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .container{max-width:1280px;margin:0 auto;padding:0 16px}
    a{color:inherit}

    /* ======== HEADER ======== */
    .nav{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(7,11,19,.92),rgba(7,11,19,.75));backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;height:56px}
    .brand-link{display:flex;align-items:center;gap:10px;padding:8px 14px;border-radius:12px;text-decoration:none;color:var(--text);background:#0b0f1a;border:1px solid var(--border);font-weight:800;letter-spacing:.2px;transition:.25s}
    .brand-link:hover{background:linear-gradient(90deg,rgba(125,240,255,.28),rgba(123,97,255,.28));border-color:transparent;box-shadow:0 0 18px rgba(125,240,255,.35);transform:translateY(-1px)}
    .logo-dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(90deg,#7df0ff,#7b61ff);box-shadow:0 0 16px rgba(125,240,255,.35)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:14px;border:1px solid var(--border);background:#0b0f1a;color:var(--text);font-weight:800;text-decoration:none;transition:.25s}
    .pill:hover{background:linear-gradient(90deg,rgba(125,240,255,.28),rgba(123,97,255,.28));border-color:transparent;box-shadow:0 0 18px rgba(125,240,255,.35);transform:translateY(-1px)}

    /* ======== LAYOUT ======== */
    .wrap{max-width:1280px;margin:28px auto 64px;padding:0 16px}
    .page-title{font-size:28px;font-weight:800;margin:8px 0 12px}
    .muted{color:var(--muted)}

    /* ======== FILTERS ======== */
    .filters{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin:20px 0}
    .card{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:14px;padding:14px;backdrop-filter:blur(6px);box-shadow:0 20px 60px -25px rgba(0,0,0,.6)}
    .control{display:flex;flex-direction:column;gap:6px}
    .control label{font-size:12.5px;color:var(--muted)}
    .control input,.control select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b0f1a;color:var(--text);transition:.2s}
    .control input:focus,.control select:focus{border-color:transparent;box-shadow:0 0 0 2px rgba(125,240,255,.35)}
    .actions{display:flex;gap:10px;align-items:end}
    .btn{padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:#0b0f1a;color:var(--text);font-weight:700;cursor:pointer;transition:.25s}
    .btn:hover{background:linear-gradient(90deg,rgba(125,240,255,.28),rgba(123,97,255,.28));border-color:transparent;box-shadow:0 0 18px rgba(125,240,255,.35);transform:translateY(-1px)}

    /* ======== SUMMARY ======== */
    .summary{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0 16px}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text);font-weight:700;font-size:12.8px}

    /* ======== TABLE ======== */
    .table-wrap{overflow:auto;border-radius:14px}
    table{width:100%;border-collapse:separate;border-spacing:0;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:14px}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));backdrop-filter:blur(4px)}
    th,td{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);white-space:nowrap}
    th{font-size:13px;color:var(--muted);cursor:pointer}
    td{font-size:14px}
    tr:hover td{background:rgba(125,240,255,.04)}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .ticker{font-weight:800;letter-spacing:.2px}
    .badge{padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}

    /* ======== BOTTOM ======== */
    .bottombar{display:flex;gap:12px;justify-content:space-between;align-items:center;margin-top:12px}
    .search{min-width:260px}
    .pagination{display:flex;gap:6px}
    .pagebtn{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0b0f1a;color:var(--text);cursor:pointer}
    .pagebtn[disabled]{opacity:.5;cursor:default}

    @media (max-width: 860px){ .filters{grid-template-columns:1fr 1fr} .actions{grid-column:1 / -1} }
  </style>
</head>
<body>

  <header class="nav">
    <div class="container nav-inner">
      <a class="brand-link" href="https://www.hivio.uk"><span class="logo-dot"></span><span>Hivio LTD</span></a>
      <div class="nav-center"><a class="pill" href="./cabinet.html">Dashboard</a></div>
      <span class="pill" style="opacity:.8">Analytics</span>
    </div>
  </header>

  <main class="wrap">
    <h1 class="page-title">Analytics <span class="muted">/ Screener</span></h1>
    <div class="muted">Find companies by exchange, sector, and key financial ratios.</div>

    <!-- FILTERS -->
    <section class="filters">
      <div class="card control" style="grid-column: span 2;">
        <label for="fExchange">Exchange</label>
        <select id="fExchange">
          <option value="nasdaq" selected>Nasdaq</option>
          <option value="nyse">NYSE</option>
          <option value="amex">AMEX</option>
        </select>
      </div>
      <div class="card control" style="grid-column: span 2;">
        <label for="fIndex">Index</label>
        <select id="fIndex">
          <option value="">‚Äî</option>
          <option value="sp500">S&P 500</option>
          <option value="nasdaq">Nasdaq 100</option>
          <option value="dow">Dow Jones</option>
          <option value="russell">Russell 2000</option>
        </select>
      </div>
      <div class="card control" style="grid-column: span 2;">
        <label for="fCountry">Country</label>
        <select id="fCountry">
          <option value="US" selected>United States</option>
          <option value="CA">Canada</option>
          <option value="GB">United Kingdom</option>
          <option value="DE">Germany</option>
        </select>
      </div>
      <div class="card control" style="grid-column: span 2;">
        <label for="fSector">Sector</label>
        <select id="fSector">
          <option value="">Any</option>
          <option value="Technology">Technology</option>
          <option value="Healthcare">Healthcare</option>
          <option value="Energy">Energy</option>
          <option value="Financial">Financial</option>
          <option value="Consumer">Consumer</option>
        </select>
      </div>
      <div class="card control" style="grid-column: span 2;">
        <label for="fPeMax">P/E max</label>
        <input id="fPeMax" type="number" value="20" />
      </div>
      <div class="card control" style="grid-column: span 2;">
        <label for="fPbMax">P/B max</label>
        <input id="fPbMax" type="number" value="3" />
      </div>
      <div class="card control" style="grid-column: span 2;">
        <label for="fRoeMin">ROE min (%)</label>
        <input id="fRoeMin" type="number" value="15" />
      </div>
      <div class="card control" style="grid-column: span 2;">
        <label for="fYieldMin">Dividend Yield min (%)</label>
        <input id="fYieldMin" type="number" value="0" />
      </div>
      <div class="actions" style="grid-column: span 2;">
        <button class="btn" id="btnFind">üîç Find</button>
        <button class="btn" id="btnExport">‚¨á Export CSV</button>
      </div>
    </section>

    <!-- SUMMARY -->
    <section class="summary" id="summary">
      <span class="chip" id="sumCount">0 found</span>
      <span class="chip" id="sumAvgRoe">Avg ROE: ‚Äî</span>
      <span class="chip" id="sumCap">Total Cap: ‚Äî</span>
    </section>

    <!-- TABLE -->
    <section class="table-wrap card">
      <table id="tbl">
        <thead>
          <tr>
            <th data-sort="ticker">Ticker</th>
            <th data-sort="name">Name</th>
            <th class="num" data-sort="marketCapUSD">Market Cap ($M)</th>
            <th class="num" data-sort="ROE">ROE (%)</th>
            <th class="num" data-sort="pe">P/E</th>
            <th class="num" data-sort="pb">P/B</th>
            <th class="num" data-sort="evebitda">EV/EBITDA</th>
            <th>Sector</th>
            <th>Country</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <!-- SEARCH & PAGINATION -->
    <div class="bottombar">
      <div class="control search">
        <label for="fSearch">Search</label>
        <input id="fSearch" type="text" placeholder="Ticker / Name‚Ä¶" />
      </div>
      <div class="pagination">
        <button class="pagebtn" id="prevPage">Prev</button>
        <span class="chip" id="pageInfo">Page 1/1</span>
        <button class="pagebtn" id="nextPage">Next</button>
      </div>
    </div>
  </main>

  <script>
    // –£–∫–∞–∂–∏ —è–≤–Ω–æ –±–∞–∑—É API (–∏–ª–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏ window.HIVIO_API_BASE —Ä–∞–Ω—å—à–µ)
    const API_BASE = window.HIVIO_API_BASE || 'https://hivio-api.onrender.com';
    const API_PATH = '/companies';
    const PAGE_SIZE = 25;

    let rawRows = [], viewRows = [], currentPage = 1, sortKey = 'ROE', sortDir = 'desc';

    const $ = (s)=>document.querySelector(s);
    const fmtNum = (n,d=1)=>(n==null||isNaN(n))?'‚Äî':Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
    const toM = (usd)=>(usd?usd/1e6:null);

    function buildQuery(){
      const p=new URLSearchParams({
        exchange:$('#fExchange').value,
        index:$('#fIndex').value,
        country:$('#fCountry').value,
        sector:$('#fSector').value,
        pe_max:$('#fPeMax').value,
        pb_max:$('#fPbMax').value,
        roe_min:$('#fRoeMin').value,
        yield_min:$('#fYieldMin').value
      });
      return p.toString();
    }

    function computeSummary(rows){
      const count=rows.length;
      const avgRoe=count?rows.reduce((a,b)=>a+(+b.ROE||0),0)/count:null;
      const totalCap=rows.reduce((a,b)=>a+(toM(b.marketCapUSD)||0),0);
      $('#sumCount').textContent=`${count} found`;
      $('#sumAvgRoe').textContent=`Avg ROE: ${avgRoe?fmtNum(avgRoe,1)+'%':'‚Äî'}`;
      $('#sumCap').textContent=`Total Cap: ${fmtNum(totalCap,1)} M`;
    }

    function applySearch(){
      const q=$('#fSearch').value.toLowerCase();
      viewRows=q?rawRows.filter(r=>(r.ticker||'').toLowerCase().includes(q)||(r.name||'').toLowerCase().includes(q)):[...rawRows];
    }

    function applySort(){
      const dir=(sortDir==='asc'?1:-1);
      viewRows.sort((a,b)=>((+a[sortKey]||0)-(+b[sortKey]||0))*dir);
    }

    function renderTable(){
      const start=(currentPage-1)*PAGE_SIZE;
      const page=viewRows.slice(start,start+PAGE_SIZE);
      $('#tbody').innerHTML=page.map(r=>`
        <tr>
          <td class="ticker">${r.ticker||'‚Äî'}</td>
          <td>${r.name||'‚Äî'}</td>
          <td class="num">${fmtNum(toM(r.marketCapUSD),1)}</td>
          <td class="num"><span class="badge">${fmtNum(r.ROE,1)}</span></td>
          <td class="num">${fmtNum(r.pe,2)}</td>
          <td class="num">${fmtNum(r.pb,2)}</td>
          <td class="num">${fmtNum(r.evebitda,2)}</td>
          <td>${r.sector||'‚Äî'}</td>
          <td>${r.country||'‚Äî'}</td>
        </tr>`).join('');
      const totalPages=Math.max(1,Math.ceil(viewRows.length/PAGE_SIZE));
      $('#pageInfo').textContent=`Page ${currentPage}/${totalPages}`;
      $('#prevPage').disabled=currentPage<=1;
      $('#nextPage').disabled=currentPage>=totalPages;
      computeSummary(viewRows);
    }

    async function fetchData(){
      const url=`${API_BASE}${API_PATH}?${buildQuery()}`;
      const btn = document.getElementById('btnFind');
      const prevTxt = btn.textContent;
      btn.textContent='Loading‚Ä¶'; btn.disabled = true;
      try{
        const res=await fetch(url,{mode:'cors'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data=await res.json();
        rawRows=(data.results||data||[]).map(x=>({
          ticker:x.ticker||x.symbol,
          name:x.name||x.companyName,
          marketCapUSD:x.marketCapUSD||x.market_cap||x.marketCap,
          ROE:(typeof x.ROE==='number')?x.ROE:(typeof x.roe==='number'?(x.roe>1?x.roe:x.roe*100):null),
          pe:x.pe||x.PE||x.p_e,
          pb:x.pb||x.PB||x.p_b,
          evebitda:x.evebitda||x.ev_ebitda||x.evEbitda,
          sector:x.sector, country:x.country||x.Country
        }));
        applySearch(); applySort(); currentPage=1; renderTable();
      }catch(e){
        console.error(e);
        alert('API error: ' + (e?.message || 'Network error'));
      }finally{
        btn.textContent=prevTxt; btn.disabled=false;
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('th[data-sort]').forEach(th=>{
        th.addEventListener('click', ()=>{
          const key=th.dataset.sort;
          if(sortKey===key){ sortDir=(sortDir==='asc'?'desc':'asc'); } else { sortKey=key; sortDir='desc'; }
          applySort(); currentPage=1; renderTable();
        });
      });
      $('#btnFind').addEventListener('click',fetchData);
      $('#prevPage').addEventListener('click',()=>{ if(currentPage>1){ currentPage--; renderTable(); } });
      $('#nextPage').addEventListener('click',()=>{ const t=Math.max(1,Math.ceil(viewRows.length/PAGE_SIZE)); if(currentPage<t){ currentPage++; renderTable(); } });
      $('#fSearch').addEventListener('input',()=>{ applySearch(); applySort(); renderTable(); });

      // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
      fetchData();
    });
  </script>
</body>
</html>
