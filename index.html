<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hivio — Agent CRM & Process Builder</title>
<meta name="description" content="Register with email OTP, create a company, invite teammates, and design live business processes with draggable nodes and smart links.">

<!-- Tech palette + subtle glow -->
<style>
  :root{
    --bg-0:#0b1020;     /* deep navy */
    --bg-1:#0f1733;     /* indigo */
    --panel:rgba(255,255,255,.05);
    --ring:rgba(255,255,255,.12);
    --text:#e8eef8;
    --muted:#9fb0c9;
    --primary:#6ee7ff;  /* neon cyan */
    --secondary:#7c7cff;/* electric indigo */
    --accent:#36d1dc;   /* cyan */
    --accent2:#5b86e5;  /* blue */
    --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial;color:var(--text);
    background:
      radial-gradient(900px 500px at 80% -10%, rgba(108,99,255,.30), transparent 60%),
      radial-gradient(700px 420px at 10% 10%, rgba(54,209,220,.20), transparent 60%),
      linear-gradient(180deg,var(--bg-0),var(--bg-1));
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }
  a{color:inherit}
  .wrap{max-width:1220px;margin:0 auto;padding:24px 16px 48px}

  .glass{
    border:1px solid var(--ring);border-radius:16px;background:var(--panel);backdrop-filter:blur(8px);
    box-shadow:0 10px 40px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
  }

  /* NAV */
  .nav{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px}
  .logo{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;font-weight:900;color:#0a1020;
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    box-shadow:0 0 24px rgba(108,99,255,.45), inset 0 0 0 2px rgba(0,0,0,.25);
  }
  .btn{display:inline-flex;align-items:center;gap:8px;height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--ring);
    background:transparent;color:var(--text);cursor:pointer}
  .btn.primary{border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#08111f;font-weight:700}
  .btn:hover{background:rgba(255,255,255,.05)}

  /* LAYOUT */
  .grid{display:grid;grid-template-columns:340px 1fr;gap:16px;margin-top:16px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .panel{padding:16px}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{
    width:100%;padding:10px 12px;margin-top:6px;border-radius:12px;border:1px solid var(--ring);
    background:#0c1428;color:var(--text)
  }
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .tag{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--ring);background:rgba(255,255,255,.05)}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .hidden{display:none}

  /* CANVAS */
  #canvasWrap{position:relative;height:660px;border:1px dashed var(--ring);border-radius:16px;background:rgba(255,255,255,.03)}
  svg#edges{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
  .node{
    position:absolute;min-width:120px;min-height:54px;padding:12px;border-radius:14px;border:1px solid var(--ring);
    background:#0c1428;box-shadow:0 16px 48px rgba(0,0,0,.35),0 0 0 1px rgba(255,255,255,.03);cursor:grab;transition:.15s transform;
  }
  .node:active{cursor:grabbing} .node .title{font-weight:700}
  .node .pins{position:absolute;inset:auto -8px -8px auto;display:flex;gap:8px}
  .pin{width:14px;height:14px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #fff, var(--primary) 40%, var(--secondary));
    border:1px solid #0b1020;box-shadow:0 0 0 2px rgba(0,0,0,.35);cursor:crosshair}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .palette{display:flex;gap:8px;flex-wrap:wrap}
  .dot{width:18px;height:18px;border-radius:999px;border:1px solid var(--ring);cursor:pointer}
  .section-title{margin:0 0 10px;font-size:18px;opacity:.9}
</style>
</head>
<body>
<div class="wrap">
  <!-- NAV -->
  <div class="glass nav">
    <div class="brand"><div class="logo">H</div><span>Hivio · Agent CRM</span></div>
    <div id="authBox">
      <button id="btnOpenAuth" class="btn">Sign in / Register</button>
      <span id="userEmail" class="tag hidden"></span>
      <button id="btnSignOut" class="btn hidden">Sign out</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: AUTH, COMPANY, INSPECTOR -->
    <div class="glass panel">
      <h3 class="section-title">Access</h3>
      <div id="authPanel" class="hidden">
        <div class="row">
          <div>
            <label>Email</label>
            <input id="inpEmail" type="email" placeholder="you@company.com" />
          </div>
          <div style="display:flex;align-items:end"><button id="btnSendCode" class="btn primary">Send code</button></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Code from email</label>
            <input id="inpCode" placeholder="123456" />
          </div>
          <div style="display:flex;align-items:end"><button id="btnVerify" class="btn">Verify</button></div>
        </div>
        <div id="authMsg" class="tag" style="margin-top:8px"></div>
      </div>

      <div id="companyPanel" class="hidden" style="margin-top:10px">
        <h3 class="section-title">Company</h3>
        <div class="row">
          <div><label>Company name</label><input id="companyName" placeholder="Hivio LTD" /></div>
          <div style="display:flex;align-items:end"><button id="btnCreateCompany" class="btn primary">Create</button></div>
        </div>
        <div style="margin-top:8px">
          <label>Invite teammate</label>
          <div class="row">
            <input id="inviteEmail" placeholder="teammate@company.com" />
            <select id="inviteRole"><option>admin</option><option selected>member</option><option>viewer</option></select>
          </div>
          <button id="btnInvite" class="btn" style="margin-top:8px">Add</button>
          <div id="inviteMsg" class="tag" style="margin-top:8px"></div>
        </div>
      </div>

      <hr style="border-color:var(--ring);margin:16px 0">
      <h3 class="section-title">Process Inspector</h3>
      <div class="toolbar" style="margin-bottom:8px">
        <button id="btnAddBox" class="btn">Add box</button>
        <button id="btnAddOval" class="btn">Add oval</button>
        <button id="btnConnect" class="btn">Connect</button>
        <button id="btnSave" class="btn primary">Save</button>
      </div>
      <div class="palette">
        <div class="dot" data-color="#6ee7ff" style="background:#6ee7ff"></div>
        <div class="dot" data-color="#7c7cff" style="background:#7c7cff"></div>
        <div class="dot" data-color="#22c55e" style="background:#22c55e"></div>
        <div class="dot" data-color="#f59e0b" style="background:#f59e0b"></div>
        <div class="dot" data-color="#ef4444" style="background:#ef4444"></div>
      </div>
      <div style="margin-top:8px">
        <label>Title</label><input id="nodeTitle" placeholder="Process step…">
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Font size</label><input id="fontSize" type="number" value="14"></div>
        <div><label>Corner radius</label><input id="radius" type="number" value="14"></div>
      </div>
    </div>

    <!-- RIGHT: CANVAS -->
    <div class="glass panel">
      <h3 class="section-title" style="display:flex;align-items:center;justify-content:space-between">
        Business Process <span id="saveStatus" class="tag">not saved</span>
      </h3>
      <div id="canvasWrap">
        <svg id="edges"></svg>
      </div>
      <p class="tag" style="margin-top:8px">Drag nodes · Select to edit · Click “Connect”, then source → target.</p>
    </div>
  </div>

  <div class="glass panel" style="margin-top:16px">
    <h3 class="section-title">Company CRM</h3>
    <div class="row">
      <div><label>About</label><textarea id="about" rows="3" placeholder="What the company does…"></textarea></div>
      <div>
        <label>Website</label><input id="website" placeholder="https://" />
        <label style="margin-top:8px;display:block">Industry</label><input id="industry" placeholder="SaaS / e-commerce / manufacturing…" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div><label>Headcount</label><input id="headcount" type="number" placeholder="25" /></div>
      <div><label>HQ</label><input id="hq" placeholder="London, UK" /></div>
    </div>
  </div>

  <p style="text-align:center;color:var(--muted);margin-top:12px">© Hivio LTD · The future runs on AI agents</p>
</div>

<!-- App (Supabase + canvas) -->
<script type="module">
  // ====== CONFIG: put your own Supabase keys here ======
  const SUPABASE_URL  = "https://YOUR-PROJECT-ref.supabase.co";
  const SUPABASE_ANON = "YOUR-ANON-PUBLIC-KEY";
  // =====================================================
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

  // Shortcuts for DOM
  const $ = (id)=>document.getElementById(id);
  const authPanel = $("authPanel"), btnOpenAuth = $("btnOpenAuth"), btnSendCode = $("btnSendCode"),
        btnVerify = $("btnVerify"), btnSignOut = $("btnSignOut"), inpEmail = $("inpEmail"),
        inpCode = $("inpCode"), authMsg = $("authMsg"), userEmail = $("userEmail"),
        companyPanel = $("companyPanel"), companyName = $("companyName"),
        btnCreateCompany = $("btnCreateCompany"), inviteEmail = $("inviteEmail"),
        inviteRole = $("inviteRole"), btnInvite = $("btnInvite"), inviteMsg = $("inviteMsg"),
        canvasWrap = $("canvasWrap"), edgesSvg = $("edges"),
        nodeTitle = $("nodeTitle"), fontSize = $("fontSize"), radius = $("radius"),
        btnAddBox = $("btnAddBox"), btnAddOval = $("btnAddOval"),
        btnConnect = $("btnConnect"), btnSave = $("btnSave"), saveStatus = $("saveStatus");

  // Palette
  let currentColor = "#6ee7ff";
  document.querySelectorAll('.dot').forEach(d => d.onclick = () => {
    currentColor = d.dataset.color;
    if (selected) { const n = get(selected.dataset.id); n.color = currentColor; draw(); dirty(); }
  });

  // Auth
  btnOpenAuth.onclick = ()=> authPanel.classList.toggle("hidden");
  btnSendCode.onclick = async ()=>{
    authMsg.textContent="Sending code…";
    const { error } = await sb.auth.signInWithOtp({ email: inpEmail.value, options:{ shouldCreateUser:true } });
    authMsg.textContent = error ? `Error: ${error.message}` : "Code sent. Check inbox.";
  };
  btnVerify.onclick = async ()=>{
    authMsg.textContent="Verifying…";
    const { error } = await sb.auth.verifyOtp({ email: inpEmail.value, token: inpCode.value, type:"email" });
    authMsg.textContent = error ? `Error: ${error.message}` : "Verified!";
    await refresh();
  };
  btnSignOut.onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };

  // Session & default company
  let activeCompany=null, currentUserId=null, diagramId=null;
  async function refresh(){
    const { data:{ user } } = await sb.auth.getUser();
    if (user){
      currentUserId = user.id;
      userEmail.textContent = user.email; userEmail.classList.remove("hidden");
      btnSignOut.classList.remove("hidden"); btnOpenAuth.classList.add("hidden");
      authPanel.classList.add("hidden"); companyPanel.classList.remove("hidden");

      const { data: comps } = await sb.from('companies').select('id,name').eq('owner', user.id).limit(1);
      if (comps?.length){ activeCompany = comps[0]; await loadDiagram(); }
    }
  }
  await refresh();

  // Company & invites
  btnCreateCompany.onclick = async ()=>{
    if (!companyName.value.trim()) return;
    const { data:{user} } = await sb.auth.getUser();
    const { data, error } = await sb.from('companies').insert({
      owner:user.id, name:companyName.value.trim()
    }).select('id,name').single();
    if (error) return alert(error.message);
    activeCompany = data; alert("Company created"); await loadDiagram();
  };
  btnInvite.onclick = async ()=>{
    if (!activeCompany) return inviteMsg.textContent="Create a company first.";
    const { data:{user} } = await sb.auth.getUser();
    const { error } = await sb.from('memberships').upsert({
      company_id: activeCompany.id,
      user_id: user.id,          // NOTE: для настоящих инвайтов позже подменим на приглашённого user_id
      user_email: inviteEmail.value.trim(),
      role: inviteRole.value
    });
    inviteMsg.textContent = error ? `Error: ${error.message}` : "Invitation recorded.";
  };

  // Diagram editor
  let nodes=[], edges=[], selected=null, connecting=false;
  const uid=()=>Math.random().toString(36).slice(2,9);

  function addNode(shape='box'){
    const n={id:uid(),x:40+nodes.length*14,y:40+nodes.length*14,w:180,h:70,shape,
             title:shape==='box'?'Step':'Decision',color:currentColor,fs:14,rad:shape==='box'?14:24};
    nodes.push(n); mount(n); draw();
  }
  function mount(n){
    const el=document.createElement('div'); el.className='node glass'; el.dataset.id=n.id;
    el.style.left=n.x+'px'; el.style.top=n.y+'px'; el.style.width=n.w+'px'; el.style.height=n.h+'px';
    el.style.borderColor=n.color; el.style.borderRadius=n.rad+'px';
    el.innerHTML=`<div class="title" style="font-size:${n.fs}px">${n.title}</div>
                  <div class="pins"><div class="pin" title="connect"></div></div>`;
    canvasWrap.appendChild(el);
    n.el=el; enableDrag(el);
    el.onclick=(e)=>{ if(e.target.classList.contains('pin'))return; select(el); };
    el.querySelector('.pin').onclick=(e)=>{ e.stopPropagation(); startConnect(el); };
  }
  function select(el){
    selected?.classList.remove('selected');
    selected=el; const n=get(el.dataset.id);
    nodeTitle.value=n.title; fontSize.value=n.fs; radius.value=n.rad;
  }
  function get(id){ return nodes.find(n=>n.id===id); }

  function enableDrag(el){
    let sx,sy,ox,oy;
    el.addEventListener('pointerdown',e=>{
      if(e.button!==0)return; sx=e.clientX; sy=e.clientY; ox=parseInt(el.style.left); oy=parseInt(el.style.top);
      el.setPointerCapture(e.pointerId);
      const move=(ev)=>{ el.style.left=(ox+ev.clientX-sx)+'px'; el.style.top=(oy+ev.clientY-sy)+'px'; draw(); };
      const up=()=>{ el.releasePointerCapture(e.pointerId); document.removeEventListener('pointermove',move); document.removeEventListener('pointerup',up);
        const n=get(el.dataset.id); n.x=parseInt(el.style.left); n.y=parseInt(el.style.top); dirty(); };
      document.addEventListener('pointermove',move); document.addEventListener('pointerup',up);
    });
  }
  function startConnect(fromEl){
    if(!connecting){ connecting=fromEl; btnConnect.classList.add('active'); }
    else { const a=connecting.dataset.id, b=fromEl.dataset.id; if(a!==b) edges.push({id:uid(),from:a,to:b});
           connecting=false; btnConnect.classList.remove('active'); draw(); dirty(); }
  }
  function draw(){
    // nodes
    nodes.forEach(n=>{
      if(!n.el)return; n.el.style.borderColor=n.color; n.el.style.borderRadius=n.rad+'px';
      n.el.querySelector('.title').textContent=n.title; n.el.querySelector('.title').style.fontSize=n.fs+'px';
    });
    // edges
    edgesSvg.innerHTML='';
    const NS='http://www.w3.org/2000/svg';
    if(!document.getElementById('defs')){
      const defs=document.createElementNS(NS,'defs'); defs.id='defs';
      const g=document.createElementNS(NS,'linearGradient'); g.id='wire'; g.setAttribute('x1','0%'); g.setAttribute('x2','100%');
      const s1=document.createElementNS(NS,'stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color', '#6ee7ff');
      const s2=document.createElementNS(NS,'stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#7c7cff');
      g.appendChild(s1); g.appendChild(s2); defs.appendChild(g); edgesSvg.appendChild(defs);
    }
    edges.forEach(e=>{
      const A=get(e.from), B=get(e.to); if(!A||!B)return;
      const ax=A.x+A.w, ay=A.y+A.h/2, bx=B.x, by=B.y+B.h/2, mid=(ax+bx)/2;
      const p=document.createElementNS(NS,'path');
      p.setAttribute('d',`M${ax},${ay} C ${mid},${ay} ${mid},${by} ${bx},${by}`);
      p.setAttribute('fill','none'); p.setAttribute('stroke','url(#wire)'); p.setAttribute('stroke-width','3'); p.setAttribute('opacity','.95');
      edgesSvg.appendChild(p);
    });
  }

  // Inspector bindings
  btnAddBox.onclick=()=>addNode('box');
  btnAddOval.onclick=()=>addNode('oval');
  btnConnect.onclick=()=>{ connecting=false; };
  nodeTitle.oninput=()=>{ if(!selected)return; const n=get(selected.dataset.id); n.title=nodeTitle.value; draw(); dirty(); };
  fontSize.oninput=()=>{ if(!selected)return; const n=get(selected.dataset.id); n.fs=+fontSize.value; draw(); dirty(); };
  radius.oninput=()=>{ if(!selected)return; const n=get(selected.dataset.id); n.rad=+radius.value; draw(); dirty(); };

  // Save / load
  function dirty(){ saveStatus.textContent='unsaved changes'; }
  function clearCanvas(){ [...canvasWrap.querySelectorAll('.node')].forEach(n=>n.remove()); edgesSvg.innerHTML=''; }
  function restore(){ clearCanvas(); nodes.forEach(n=>mount(n)); draw(); }

  async function loadDiagram(){
    if(!activeCompany) return;
    const { data } = await sb.from('diagrams').select('id,payload').eq('company_id',activeCompany.id).limit(1).maybeSingle();
    if(data){ diagramId=data.id; nodes=data.payload.nodes||[]; edges=data.payload.edges||[]; restore(); }
    else { nodes=[]; edges=[]; clearCanvas(); }
    saveStatus.textContent='loaded';
  }

  btnSave.onclick=async ()=>{
    if(!activeCompany) return alert('Create a company first');
    const payload={ nodes:nodes.map(n=>({id:n.id,x:n.x,y:n.y,w:n.w,h:n.h,shape:n.shape,title:n.title,color:n.color,fs:n.fs,rad:n.rad})), edges };
    if(diagramId){
      const { error } = await sb.from('diagrams').update({ payload, updated_at:new Date().toISOString() }).eq('id',diagramId);
      if(error) return alert(error.message);
    }else{
      const { data, error } = await sb.from('diagrams').insert({ company_id:activeCompany.id, payload }).select('id').single();
      if(error) return alert(error.message); diagramId=data.id;
    }
    saveStatus.textContent='saved ✓';
  };
</script>
</body>
</html>
